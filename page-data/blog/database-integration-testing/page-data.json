{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/database-integration-testing/","result":{"data":{"site":{"siteMetadata":{"title":"Testing Boss","siteUrl":"https://testingboss.com","keywords":"testingboss, testing, boss, test, automation, software, development, coding"}},"markdownRemark":{"id":"156533d4-21f6-5a33-98bb-55528cad3570","fields":{"slug":"/database-integration-testing/"},"excerpt":"For database integration testing an in-memory database like H2 is commonly used. However, this does not guarantee that your application actually works properly…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAgAB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAFh2bko/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAECERIhIv/aAAgBAQABBQK+Dbi7yeEYlI//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAdEAACAgEFAAAAAAAAAAAAAAAAEQECQRAxUWGB/9oACAEBAAY/AuzdaRXPJKl+Drk//8QAGhAAAgMBAQAAAAAAAAAAAAAAAREAIVExQf/aAAgBAQABPyFvNg3CXY4RYErBh4lDJYYyYsRhn//aAAwDAQACAAMAAAAQKC//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAGxABAQACAwEAAAAAAAAAAAAAAREAITFBYZH/2gAIAQEAAT8QEBNTQU8y+1QpCvX3FzaQQA1TEEBPqro8BMtjxeAzJCYoHXAhes//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Library\"\n        title=\"\"\n        src=\"/static/a0c109298a94f4640675e5ac60a9c447/4b190/library.jpg\"\n        srcset=\"/static/a0c109298a94f4640675e5ac60a9c447/e07e9/library.jpg 200w,\n/static/a0c109298a94f4640675e5ac60a9c447/066f9/library.jpg 400w,\n/static/a0c109298a94f4640675e5ac60a9c447/4b190/library.jpg 800w,\n/static/a0c109298a94f4640675e5ac60a9c447/e5166/library.jpg 1200w,\n/static/a0c109298a94f4640675e5ac60a9c447/b17f8/library.jpg 1600w,\n/static/a0c109298a94f4640675e5ac60a9c447/d2602/library.jpg 4032w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>For database integration testing an in-memory database like H2 is commonly used. However, this does not guarantee that your application actually works properly with the production database, which is not an in-memory database. The H2 database has many limitations as listed <a href=\"https://www.h2database.com/html/advanced.html?search=limitation#limits_limitations\">here</a> and more importantly the limitations on the compatbility modes described <a href=\"http://www.h2database.com/html/features.html#compatibility\">here</a>. This means that for example a simple DDL script on a real database will not always work on H2 in a compatibility mode.</p>\n<p>So an in-memory database has its limitations, but how can we test the integration with a real database? Well, either connect to an actual database which is production-like, or use <a href=\"https://www.testcontainers.org/\">Testcontainers</a> which we will focus on here. This enables to test the application under test with an actual database locally by basically spinning up a Docker container for the database on-the-fly.</p>\n<p>Let’s set it up, using MySQL as an example.</p>\n<p>First, add the necessary dependencies to the project.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.testcontainers<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mysql<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${mysql.version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.mysql<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mysql-connector-j<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${mysql-connector-j.version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Configure your application to connect to the MySQL container from Testcontainers. In a Spring Boot application it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>tc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>///test</code></pre></div>\n<p>Finally, use the database container in your test as follows.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ContactClient</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ContactClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Faker</span> faker <span class=\"token operator\">=</span> <span class=\"token class-name\">Faker</span><span class=\"token punctuation\">.</span><span class=\"token function\">instance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MySQLContainer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> mysql <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MySQLContainer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@BeforeEach</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">startContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mysql<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">shouldCreateContactWithRealDatabase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> contactId <span class=\"token operator\">=</span> faker<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">nextLong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Contact</span> contact <span class=\"token operator\">=</span> <span class=\"token class-name\">Contact</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">withId</span><span class=\"token punctuation\">(</span>contactId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">withLastName</span><span class=\"token punctuation\">(</span>faker<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">lastName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">withFirstName</span><span class=\"token punctuation\">(</span>faker<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">firstName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">withPhone</span><span class=\"token punctuation\">(</span>faker<span class=\"token punctuation\">.</span><span class=\"token function\">phoneNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">cellPhone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    client<span class=\"token punctuation\">.</span><span class=\"token function\">createContact</span><span class=\"token punctuation\">(</span>contact<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">statusCode</span><span class=\"token punctuation\">(</span><span class=\"token number\">201</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Contact</span> actualContact <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getContact</span><span class=\"token punctuation\">(</span>contactId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>actualContact<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>contact<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note: this test is based on the <a href=\"/blog/client-test-model-for-rest-api-testing/\">Client-Test Model</a>.</p>\n<p>The database container will be spun up before the test and shut down after it.</p>\n<p>A few built-in features from Testcontainers that are noteworthy:</p>\n<ul>\n<li>You can set a specific Docker image and tag in the constructor of <code class=\"language-text\">MySQLContainer</code> (similarly for any other database).</li>\n<li>To create tables with a DDL script when creating the database container, it can be specified like this: <code class=\"language-text\">new MySQLContainer&lt;>().withInitScript(\"init.ddl\")</code>.</li>\n<li>It is possible to keep the container alive by utilizing the “reuse” feature from Testcontainers so that you can analyze the actual database state after the test. Create a <code class=\"language-text\">testcontainers.properties</code> file on the classpath with <code class=\"language-text\">testcontainers.reuse.enable=true</code> as contents.</li>\n</ul>\n<h1>Conclusion</h1>\n<p><a href=\"https://www.testcontainers.org/\">Testcontainers</a> can be used to test the integration of your application with a real database without relying on a full-blown testing environment. This makes it easy to test this integration locally and on CI pipelines.</p>","frontmatter":{"title":"Database Integration Testing with Testcontainers","date":"1 May 2023","description":"Use Testcontainers to test integration with databases.","tags":["automation","testcontainers","database","integration","docker","container"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#787868","images":{"fallback":{"src":"/static/a0c109298a94f4640675e5ac60a9c447/51a07/library.jpg","srcSet":"/static/a0c109298a94f4640675e5ac60a9c447/51a07/library.jpg 500w,\n/static/a0c109298a94f4640675e5ac60a9c447/de105/library.jpg 1000w","sizes":"500px"},"sources":[{"srcSet":"/static/a0c109298a94f4640675e5ac60a9c447/12849/library.webp 500w,\n/static/a0c109298a94f4640675e5ac60a9c447/85e35/library.webp 1000w","type":"image/webp","sizes":"500px"}]},"width":500,"height":375}}}}}},"pageContext":{"slug":"/database-integration-testing/"}},"staticQueryHashes":["1052764262","2308629918","3159585216","3849765996"],"slicesMap":{}}