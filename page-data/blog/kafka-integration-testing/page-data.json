{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/kafka-integration-testing/","result":{"data":{"site":{"siteMetadata":{"title":"Testing Boss","siteUrl":"https://testingboss.com","keywords":"testingboss, testing, boss, test, automation, software, development, coding"}},"markdownRemark":{"id":"1be74342-a9d8-51cf-9d1d-1ae534355f41","fields":{"slug":"/kafka-integration-testing/"},"excerpt":"Communication with a message broker is a common practice, used for a variety of reasons, to decouple processing from data producers, to buffer unprocessed…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAADBP/aAAwDAQACEAMQAAABxnNp1zhAaf/EABsQAAIBBQAAAAAAAAAAAAAAAAABAhAREiEx/9oACAEBAAEFAlG5qBkzkHT/xAAWEQEBAQAAAAAAAAAAAAAAAAABECL/2gAIAQMBAT8BNM//xAAWEQEBAQAAAAAAAAAAAAAAAAAAETH/2gAIAQIBAT8BxX//xAAXEAADAQAAAAAAAAAAAAAAAAAAICFh/9oACAEBAAY/Aoav/8QAGRABAAMBAQAAAAAAAAAAAAAAAQARITEQ/9oACAEBAAE/IW5Rpo2FG1jjWZO/P//aAAwDAQACAAMAAAAQxD//xAAYEQEAAwEAAAAAAAAAAAAAAAABABExUf/aAAgBAwEBPxBNThKOT//EABYRAQEBAAAAAAAAAAAAAAAAAAERAP/aAAgBAgEBPxBJpq3/xAAbEAEAAgIDAAAAAAAAAAAAAAABACEQETFRcf/aAAgBAQABPxBax7jGBpuozQrPanFSyXH/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Data streams\"\n        title=\"\"\n        src=\"/static/f0319c86b2f76e33de4adb79f3866b19/4b190/data-streams.jpg\"\n        srcset=\"/static/f0319c86b2f76e33de4adb79f3866b19/e07e9/data-streams.jpg 200w,\n/static/f0319c86b2f76e33de4adb79f3866b19/066f9/data-streams.jpg 400w,\n/static/f0319c86b2f76e33de4adb79f3866b19/4b190/data-streams.jpg 800w,\n/static/f0319c86b2f76e33de4adb79f3866b19/e5166/data-streams.jpg 1200w,\n/static/f0319c86b2f76e33de4adb79f3866b19/b17f8/data-streams.jpg 1600w,\n/static/f0319c86b2f76e33de4adb79f3866b19/a94c4/data-streams.jpg 4069w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>Communication with a message broker is a common practice, used for a variety of reasons, to decouple processing from data producers, to buffer unprocessed messages, etc. One of the most popular message brokers used at the moment is <a href=\"https://kafka.apache.org/\">Kafka</a>. Kafka can also used for other use cases, other than messaging, such as website activity tracking, metrics and log aggregation. In this article I will focus on integration testing with Kafka as a message broker.</p>\n<p>Let’s take a typical movie catalog service as an example which produces messages to and consumes messages from Kafka topics.</p>\n<ul>\n<li>Producing messages: when a movie is added to the catalog, it also sends a status update to a Kafka topic for other systems to consume.</li>\n<li>Consuming messages: the service consumes from a Kafka topic to get updates on comments</li>\n</ul>\n<p>How do integration tests look like to cover both message flows? Integration testing can be done on different levels. Here I will cover testing the service under test as close to production as possible, but without relying on other services, (shared) environments and external dependencies.</p>\n<p>We need a couple of things to achieve this:</p>\n<ul>\n<li>The Kafka message broker</li>\n<li>A <code class=\"language-text\">KafkaConsumer</code> that can consume the Kafka message that the service is sending.</li>\n<li>A <code class=\"language-text\">KafkaProducer</code> that can produce a Kafka message to the topic that the service is subscribed to.</li>\n<li>The actual test that triggers functionality on the service which then triggers the Kafka message.</li>\n<li>Another test that produces the Kafka message for the service to consume.</li>\n</ul>\n<h2>Kafka with Testcontainers</h2>\n<p>With <a href=\"https://www.testcontainers.org/\">Testcontainers</a> it is very easy to programmatically boot up a Docker container without much configuration. In this way the service under test can communicate with the Kafka broker by just configuring the correct url in the service configuration. The simplest example to spin up a Kafka container looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">KafkaContainer</span> kafka <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaContainer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DockerImageName</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"confluentinc/cp-kafka\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Yes, that’s it. There are obviously more configuration options available (check out the docs), but for this test example, let’s use this default setup.</p>\n<h2>KafkaConsumer</h2>\n<p>Here is a simple example of a <code class=\"language-text\">KafkaConsumer</code> used for testing. For demonstration purposes we will use <code class=\"language-text\">String</code> serialization. In practice, specific data serializers are usually used, such as <a href=\"https://avro.apache.org/\">Avro</a>. To test the service under test in isolation, this <code class=\"language-text\">KafkaTestConsumer</code> will simulate the behavior of an actual consumer of the Kafka topic.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KafkaTestConsumer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> consumer<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KafkaTestConsumer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bootstrapServers<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> groupId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Properties</span> props <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConsumerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BOOTSTRAP_SERVERS_CONFIG</span><span class=\"token punctuation\">,</span> bootstrapServers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConsumerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GROUP_ID_CONFIG</span><span class=\"token punctuation\">,</span> groupId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConsumerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEY_DESERIALIZER_CLASS_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StringDeserializer</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConsumerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StringDeserializer</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConsumerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO_OFFSET_RESET_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"earliest\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>consumer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> topics<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        consumer<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>topics<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ConsumerRecords</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> consumer<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Testing the production of messages</h2>\n<p>First, the test where we consume the message which the service is sending. Here we subscribe to the topic from the <code class=\"language-text\">KafkaTestConsumer</code>. When we invoke the functionality on the service under test, it will trigger sending the Kafka message. The <code class=\"language-text\">KafkaTestConsumer</code> consumes the topic and finally we can check on the message coming in.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KafkaContainer</span> kafka <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaContainer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DockerImageName</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"confluentinc/cp-kafka\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> mapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@BeforeEach</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">startContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    kafka<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">shouldSendStatusUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">KafkaTestConsumer</span> kafkaTestConsumer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaTestConsumer</span><span class=\"token punctuation\">(</span>kafka<span class=\"token punctuation\">.</span><span class=\"token function\">getBootstrapServers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test_group\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    kafkaTestConsumer<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token function\">singletonList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"catalog_topic\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> movieId <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">addMovieToCatalog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">ConsumerRecords</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> records <span class=\"token operator\">=</span> kafkaTestConsumer<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// As mentioned before, in this example we are using String serializers, in practice it is very common to use Avro schemas to serialize these messages</span>\n    records<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEachRemaining</span><span class=\"token punctuation\">(</span>record <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>mapper<span class=\"token punctuation\">.</span><span class=\"token function\">readValue</span><span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MovieState</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MovieState</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">movieId</span><span class=\"token punctuation\">(</span>movieId<span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CREATED\"</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>KafkaProducer</h3>\n<p>Very similar to the <code class=\"language-text\">KafkaConsumer</code> above, here is an example of a <code class=\"language-text\">KafkaProducer</code> used for testing which we need to simulate the behavior of an actual producer.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KafkaTestProducer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> mapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KafkaProducer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> producer<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KafkaTestProducer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bootstrapServers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Properties</span> props <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProducerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACKS_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProducerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RETRIES_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProducerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BOOTSTRAP_SERVERS_CONFIG</span><span class=\"token punctuation\">,</span> bootstrapServers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProducerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEY_SERIALIZER_CLASS_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StringSerializer</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        props<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProducerConfig</span><span class=\"token punctuation\">.</span><span class=\"token constant\">VALUE_SERIALIZER_CLASS_CONFIG</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StringSerializer</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>producer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaProducer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> topicName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> messageObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        producer<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ProducerRecord</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>topicName<span class=\"token punctuation\">,</span> mapper<span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>messageObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Testing the consumption of messages</h2>\n<p>For this test on producing a Kafka message for the service to consume, we use the <code class=\"language-text\">KafkaTestProducer</code> to send a message. After sending, we check the processed result on the service under test.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">shouldProcessComments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">KafkaTestProducer</span> kafkaTestProducer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaTestProducer</span><span class=\"token punctuation\">(</span>kafka<span class=\"token punctuation\">.</span><span class=\"token function\">getBootstrapServers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> movieId <span class=\"token operator\">=</span> <span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">getComments</span><span class=\"token punctuation\">(</span>movieId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    kafkaTestProducer<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"comments_topic\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MovieComment</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">movieId</span><span class=\"token punctuation\">(</span>movieId<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">commentId</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SUBMITTED\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">getComments</span><span class=\"token punctuation\">(</span>movieId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You might wonder how to deal with certain delays in the tests. It may take a few seconds before the comments have been updated on the service side.</p>\n<p>With <a href=\"http://www.awaitility.org/\">Awaitility</a> handling asynchronous behavior is a breeze, for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Polling until comments are received\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">pollInterval</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">atMost</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">until</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token operator\">!</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">getComments</span><span class=\"token punctuation\">(</span>movieId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here you only need to define the polling times and the condition on which it waits until it is <code class=\"language-text\">true</code>. In case it never evaluates to <code class=\"language-text\">true</code>, it will timeout based on the max timeout specified.</p>\n<h2>Conclusion</h2>\n<p>Testing Kafka messages is made easy with <a href=\"https://www.testcontainers.org/\">Testcontainers</a>. The <a href=\"https://kafka.apache.org/\">Kafka</a> Docker container is spun up on-the-fly via Testcontainers. Simulating the behavior of other systems can be simply done by creating a <code class=\"language-text\">KafkaProducer</code> or <code class=\"language-text\">KafkaConsumer</code> as part of your test. In this way your service can be completely tested without relying on any other environment or dependencies. Be aware that this type of messaging is asynchronous. To handle this in an easy way from a testing point of view, you can use <a href=\"http://www.awaitility.org/\">Awaitility</a> instead of implementing your own polling mechanism.</p>","frontmatter":{"title":"Kafka Integration Testing with Testcontainers","date":"1 Mar 2023","description":"Use Testcontainers to test Kafka messaging","tags":["automation","testcontainers","kafka","integration","async","docker","container"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080848","images":{"fallback":{"src":"/static/f0319c86b2f76e33de4adb79f3866b19/4d227/data-streams.jpg","srcSet":"/static/f0319c86b2f76e33de4adb79f3866b19/4d227/data-streams.jpg 500w,\n/static/f0319c86b2f76e33de4adb79f3866b19/8e2be/data-streams.jpg 1000w","sizes":"500px"},"sources":[{"srcSet":"/static/f0319c86b2f76e33de4adb79f3866b19/a6b00/data-streams.webp 500w,\n/static/f0319c86b2f76e33de4adb79f3866b19/49067/data-streams.webp 1000w","type":"image/webp","sizes":"500px"}]},"width":500,"height":247}}}}}},"pageContext":{"slug":"/kafka-integration-testing/"}},"staticQueryHashes":["1052764262","2308629918","3159585216","3849765996"],"slicesMap":{}}